version: 2.1

executors:
  main:
    docker:
      - image: cimg/base:2021.01
        auth:
          username: $DOCKER_USERNAME
          password: $DOCKER_PASSWORD

jobs:
  get-pull-request-changes: 
    executor: main
    steps:
      - checkout
      - run: 
          name: "git PR diff"
          command: |
            pr_number=${CIRCLE_PULL_REQUEST##*/}
            base_SHA=$( \
              curl \
              -s \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/"${CIRCLE_PROJECT_USERNAME}"/"${CIRCLE_PROJECT_REPONAME}"/pulls/"${pr_number}" \
              | jq -r '.base.sha'
            )
            git diff "$base_SHA" "$CIRCLE_SHA1" --name-only
          environment:
            TERM: xterm-256color

workflows:
  build:
    jobs:
      - get-pull-request-changes:
          context:
            - org-global
